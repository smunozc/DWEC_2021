<html>

<head>
    <meta charset="utf-8" />
    <title>Ajax con PHP y JSON</title>
    <script>
        window.addEventListener("load", inicio);

        function inicio() {
            document.getElementById("mostrar").addEventListener("click", mostrar);
        }

        function mostrar() {
            let inputTitulo = document.getElementById("titulo").value;
            let inputDirector = document.getElementById("director").value;
            let inputCadena = document.getElementById("cadena").value;
            let inputAnyo = document.getElementById("anyo").value;
            let inputTerminada = document.getElementById("terminada").checked;

            let objeto = {
                titulo: inputTitulo,
                director: inputDirector,
                cadena: inputCadena,
                anyo: parseInt(inputAnyo),
                terminada: inputTerminada
            };

            let xhr = new XMLHttpRequest();
            let txt = "";
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {

                    console.log(xhr.responseText);
                    txt = xhr.responseText;
                    let divTexto = document.getElementById("texto");

                    divTexto.innerHTML = txt;

                    if (this.responseText === '"ok"') {
                        /**
                         * TODO Terminar tarea usando fetch, ej.(fetch().then().then().catch();) y si la respuesta de este metodo es "ok" 
                         * hacer un get para que devuelva un json y pintar los datos de la bd en una tabla.
                        */
                        divTexto.style.color = "green";
                    } else {
                        divTexto.style.color = "red";
                    }

                    document.getElementById("texto").innerHTML = txt;
                }
            };

            let parametros = JSON.stringify(objeto);
            xhr.open("POST", "conexionBD.php", true);
            xhr.setRequestHeader(
                "Content-type",
                "application/x-www-form-urlencoded"
            );
            xhr.send("objeto=" + parametros);

            function cargarCatalogo() {
                let xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        console.log("Al menos entra aqui");
                        cargarJSON(xhr);
                    }
                };
                xhr.open("GET", "datosjson.php", true);
                xhr.send();
            }

            function cargarJSON(xhr) {
                let docJSON = JSON.parse(xhr.responseText);
                let tabla = "<tr><th>Título</th><th>Cadena</th><th>Director</th><th>Año</th><th>Terminada</th></tr>";
                let series = docJSON;
                for (let i = 0; i < series.length; i++) {
                    tabla += "<tr><td><strong>";

                    tabla += series[i].TITULO;

                    tabla += "</strong></td><td>";

                    tabla += series[i].CADENA;

                    tabla += "</td><td><i>";

                    tabla += series[i].DIRECTOR;

                    tabla += "</i></td><td>";

                    if (series[i].ANO < 2001) {

                        let year = series[i].ANO;
                        tabla += "<p class='rojo'>" + year + "</p>";

                    } else if (series[i].ANO >= 2001 && series[i].ANO <= 2010) {

                        let year = series[i].ANO;
                        tabla += "<p class='amarillo'>" + year + "</p>";

                    } else if (series[i].ANO > 2011) {

                        let year = series[i].ANO;
                        tabla += "<p class='verde'>" + year + "</p>";

                    }

                    tabla += "</td><td id='celdaImagen'>";

                    let src = determinarImagen(series[i].TERMINADA);
                    tabla += "<img src='" + src + "' style='width:100%;'>";

                    tabla += "</img></td></tr>";
                }
                document.getElementById("demo").innerHTML = tabla;
            }

            function determinarImagen(estadoFinalizada) {
                if (estadoFinalizada == "SI") {
                    return "./img/Si.jpg";
                } else if (estadoFinalizada == "NO") {
                    return "./img/No.jpg";
                }
            }

        }
    </script>
</head>

<body>

    <label for="titulo">Título: </label>
    <input id="titulo" type="text" name="titulo">

    <label for="director">Director: </label>
    <input id="director" type="text" name="director">

    <label for="cadena">Cadena: </label>
    <input id="cadena" type="text" name="cadena">

    <label for="anyo">Año: </label>
    <input id="anyo" type="text" name="anyo">

    <label for="terminada">Terminada: </label>
    <input id="terminada" type="checkbox" name="terminada">

    <input type="button" id="mostrar" value="mostrar">

    <div id="texto"></div>

</body>

</html>